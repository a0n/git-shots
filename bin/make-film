#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

cd "$(dirname "$0")"
SRC_SHOTS=~/.gitshots
FRAMES_DIR=gitframes
OUTPUT_VIDEO=gitmovie.avi

files_list=$(mktemp)
trap 'rm "$files_list"' EXIT
export working_dir="$FRAMES_DIR"
output_file="$OUTPUT_VIDEO"

if [[ ! -d "$working_dir" ]]; then
  mkdir --parents "$working_dir"
  find "$SRC_SHOTS" -name '*.png' -type f | sort > "$files_list"
  export files_total=$(wc -l "$files_list" | cut -f1 -d " ")
  copy_frame() {
    local file_name="$1"
    local file_index="$2"
    echo -ne "$file_index/$files_total\r"
    # for some reason I have bad headers in png files generated by fswebcam, so
    # use imagemagick (convert) and it fixes it for us
    convert "$file_name" "$working_dir/${file_index}.png"
  }
  export -f copy_frame
  # using xapply we generate pairs "filename index" and feed them into copy_frame
  parallel --env copy_frame --xapply copy_frame :::: "$files_list" ::: $(seq --format='%04.0f' 1 "$files_total")
fi

rm --force "$output_file"
# -r flag is number of frames per second
# -s resolution
# -q:v is the video quality (smaller is better)
ffmpeg -framerate 25 -r 10 -s 720x480 -i $working_dir/'%04d.png' -q:v 0 "$output_file"
